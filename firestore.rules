rules_version = '2';
service cloud.firestore {
    match /databases/{database}/documents {

    // Rules for the 'users' collection
    match /users/{userId}/{document=**} {
      // Allow the user to read their own profile
            allow read: if request.auth != null && request.auth.uid == userId;

            // Allow creation, but force isPremium to be false initially
            allow create: if request.auth != null
                          && request.auth.uid == userId
                          && (!('isPremium' in request.resource.data) || request.resource.data.isPremium == false);

            // Allow updates ONLY IF they don't change the 'isPremium' field
            allow update: if request.auth != null
                          && request.auth.uid == userId
                          && !request.resource.data.diff(resource.data).affectedKeys().hasAny(['isPremium']);
    }

    // Deny access to everything else by default
    match /{document=**} {
      allow read, write: if false;
    }
  }
}